name: CI

on:

  push:
    branches:
      - '**'
      - '!develop'
      - '!master'
      - '!release'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup app dependencies
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - uses: actions/cache@v3
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: |
            authorization-server/node_modules
            backend-server/node_modules
            generate-identity-cli/node_modules

          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: yarn install

      - name: Check linting
        run: yarn lint

      - name: Build project
        run: yarn build

      - name: Test project
        env:
          LOG_LEVEL: 'error'
          RPC_URL: 'https://volta-rpc-vkn5r5zx4ke71f9hcu0c.energyweb.org/'
          CACHE_SERVER_URL: 'https://identitycache-dev.energyweb.org/v1'
          CACHE_SERVER_LOGIN_PRVKEY: 'eab5e5ccb983fad7bf7f5cb6b475a7aea95eff0c6523291b0c0ae38b5855459c'
          DID_REGISTRY_ADDRESS: '0xc15d5a57a8eb0e1dcbe5d88b8f9a82017e5cc4af'
          ENS_REGISTRY_ADDRESS: '0xd7CeF70Ba7efc2035256d828d5287e2D285CD1ac'
          ENS_RESOLVER_ADDRESS: '0xcf72f16Ab886776232bea2fcf3689761a0b74EfE'
          IPFS_HOST: 'ewipfsgwtest.infura-ipfs.io'
          IPFS_PORT: 443
          REDIS_HOST: 'localhost'
          REDIS_PORT: 61379
          JWT_SECRET: 'asecret'
          JWT_ACCESS_TTL: 60
          JWT_REFRESH_TTL: 600
          FAIL_ON_REDIS_UNAVAILABLE: true
          AUTH_COOKIE_ENABLED: true
          IDENTITY_TOKEN: ${{ secrets.IDENTITY_TOKEN }}
          ACCEPTED_ROLES: 'role1.roles.app1.apps.artur3.iam.ewc'
        run: yarn test
